<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¿ƒç®—éŠæˆ²ï¼ˆèª²å¾Œè‡ªå­¸ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --accent:#22c55e; --muted:#94a3b8; --text:#e5e7eb; --bad:#ef4444; --good:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "PingFang TC", "Microsoft JhengHei", "Heiti TC", sans-serif; background: radial-gradient(1200px 600px at 20% 0%, #111b3a 0%, var(--bg) 60%); color: var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 16px; flex-wrap: wrap; }
    h1 { font-size: clamp(22px, 2.6vw, 36px); margin: 0; letter-spacing:0.5px; }
    .card { background: rgba(17,24,39,.85); border: 1px solid rgba(148,163,184,.15); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .col-12{grid-column: span 12;} .col-6{grid-column: span 6;} .col-4{grid-column: span 4;} .col-8{grid-column: span 8;}
    @media (max-width: 760px){ .col-6,.col-4,.col-8{grid-column: span 12;} }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom: 6px; }
    select, input[type="number"], input[type="text"] { width:100%; padding:12px 12px; border-radius: 10px; border:1px solid rgba(148,163,184,.25); background:#0b1220; color: var(--text); outline:none; }
    button { cursor:pointer; border:none; padding:12px 16px; border-radius:12px; color:#04110a; background: var(--accent); font-weight: 700; letter-spacing:.5px; }
    button.ghost{ background: transparent; color: var(--text); border:1px solid rgba(148,163,184,.3); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); color: var(--muted)}
    .stat{font-weight:700; font-variant-numeric: tabular-nums;}
    .problem{ font-size: clamp(28px, 5.2vw, 56px); text-align:center; font-weight:800; letter-spacing:1px; margin: 18px 0 8px; }
    .biginput{ font-size: clamp(20px, 3.6vw, 28px); text-align:center; padding: 14px 16px; }
    .center{ text-align:center; }
    .hint{ color: var(--muted); font-size: 14px; text-align: center; }
    .feedback{ text-align:center; font-weight:800; min-height: 28px; }
    .good{ color: var(--good); } .bad{ color: var(--bad); }
    .footer{ color: var(--muted); font-size:12px; text-align:center; margin-top:18px; }
    .small{ font-size: 12px; color: var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid rgba(148,163,184,.25); }
    .hr{ height:1px; background: rgba(148,163,184,.15); margin: 14px 0; border:0; }
    .tag{ background: rgba(34,197,94,.15); color: #86efac; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(34,197,94,.35); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>å¿ƒç®—éŠæˆ²ï¼ˆèª²å¾Œè‡ªå­¸ç‰ˆï¼‰<span class="tag" id="dailyTag"></span></h1>
      <div class="row">
        <span class="pill">æŒ‰ <span class="kbd">Enter</span> é€å‡ºã€<span class="kbd">Space</span> æ›é¡Œ</span>
        <button class="ghost" id="helpBtn">èªªæ˜</button>
      </div>
    </header>

    <div class="grid">
      <div class="col-8">
        <div class="card">
          <div class="grid">
            <div class="col-6">
              <label>æ¨¡å¼</label>
              <select id="mode">
                <option value="addsub">åŠ æ¸›</option>
                <option value="mul">ä¹˜æ³•</option>
                <option value="div">é™¤æ³•ï¼ˆæ•´é™¤ï¼‰</option>
                <option value="pow">ä¹˜æ–¹</option>
                <option value="poly">æ•´å¼åŠ æ¸›ï¼ˆax+bï¼‰</option>
              </select>
            </div>
            <div class="col-6">
              <label>é›£åº¦</label>
              <select id="difficulty">
                <option value="easy">å…¥é–€</option>
                <option value="mid" selected>ä¸€èˆ¬</option>
                <option value="hard">æŒ‘æˆ°</option>
              </select>
            </div>
            <div class="col-6">
              <label>é¡Œç›®æ•¸ï¼ˆä½œæ¥­æ¨¡å¼ï¼‰</label>
              <input type="number" id="count" min="5" max="100" value="20" />
            </div>
            <div class="col-6">
              <label>æ¯é¡Œé™æ™‚ï¼ˆç§’ï¼Œ0 è¡¨ç¤ºä¸é™æ™‚ï¼‰</label>
              <input type="number" id="perSec" min="0" max="120" value="0" />
            </div>
            <div class="col-12 row">
              <button id="startBtn">é–‹å§‹ï¼ˆä½œæ¥­æ¨¡å¼ï¼‰</button>
              <button class="ghost" id="endlessBtn">ç·´ç¿’ï¼ˆç„¡é™æ¨¡å¼ï¼‰</button>
              <button class="ghost" id="dailyBtn">æ¯æ—¥æŒ‘æˆ°</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="center small" id="status">æœªé–‹å§‹</div>
          <div class="problem" id="problem">â€”</div>
          <div class="center">
            <input id="answer" class="biginput" type="text" placeholder="åœ¨æ­¤ä½œç­”ï¼ˆå¤šé …å¼è«‹è¼¸å…¥å¦‚ 3x+2 æˆ– -x-5ï¼‰" autocomplete="off" />
          </div>
          <div class="feedback" id="feedback"></div>
          <div class="hint" id="hint"></div>
          <div class="center row" style="justify-content:center; margin-top:12px;">
            <button id="submitBtn">é€å‡º</button>
            <button class="ghost" id="skipBtn">æ›é¡Œ</button>
          </div>
          <div class="footer" id="footer">æº–å‚™ä¸­â€¦</div>
        </div>
      </div>

      <div class="col-4">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="small">å·²ç­”</div>
              <div class="stat" id="qStat">0/0</div>
            </div>
            <div>
              <div class="small">æ­£ç¢ºç‡</div>
              <div class="stat" id="acc">0%</div>
            </div>
            <div>
              <div class="small">é€£å°</div>
              <div class="stat" id="streak">0 ğŸ”¥</div>
            </div>
            <div>
              <div class="small">å€’æ•¸</div>
              <div class="stat" id="timer">â€”</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="small">æ­·å²æœ€ä½³ï¼ˆæ­¤è£ç½®ï¼‰</div>
          <div id="hall"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px; display:none;" id="resultCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3 style="margin:0">ä½œæ¥­çµæœ</h3>
        <button id="copyBtn">è¤‡è£½æˆç¸¾æ–‡å­—</button>
      </div>
      <pre id="report" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background:#0b1220; padding:12px; border-radius:12px; border:1px solid rgba(148,163,184,.25);"></pre>
    </div>

    <p class="footer">æç¤ºï¼š
      å¤šé …å¼é¡Œè«‹ä»¥ <strong>ax+b</strong> å½¢å¼ä½œç­”ï¼ˆä¾‹å¦‚ <strong>3x+2</strong>ã€<strong>-x-5</strong>ï¼‰ã€‚
      éŒ¯èª¤æ™‚æœƒé¡¯ç¤ºè§£æèˆ‡æç¤ºã€‚è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆLocalStorageï¼‰ã€‚
    </p>
  </div>

  <dialog id="helpDialog">
    <div class="card" style="max-width:700px;">
      <h3 style="margin-top:0">ä½¿ç”¨èªªæ˜</h3>
      <ol>
        <li>é¸æ“‡ã€Œæ¨¡å¼ã€ã€Œé›£åº¦ã€ï¼Œé»<strong>é–‹å§‹ï¼ˆä½œæ¥­æ¨¡å¼ï¼‰</strong>æˆ–<strong>ç·´ç¿’ï¼ˆç„¡é™æ¨¡å¼ï¼‰</strong>ã€‚</li>
        <li>æŒ‰ <span class="kbd">Enter</span> é€å‡ºç­”æ¡ˆï¼›æŒ‰ <span class="kbd">Space</span> æ›é¡Œã€‚</li>
        <li>å®Œæˆä½œæ¥­æ¨¡å¼å¾Œï¼Œå°‡ã€Œä½œæ¥­çµæœã€è¤‡è£½ä¸¦ä¸Šå‚³åˆ°ä½œæ¥­ç³»çµ±ã€‚</li>
        <li>æ¯æ—¥æŒ‘æˆ°æ¯å¤©æ›´æ–° 1 çµ„ 15 é¡Œï¼Œå®Œæˆå¯åˆ·æ–°ä½ çš„æœ€ä½³ç´€éŒ„ã€‚</li>
      </ol>
      <p class="small">å°æŠ€å·§ï¼šé‡åˆ°ä¹˜é™¤å…ˆåˆ†è§£å› æ•¸ï¼›å¤šé …å¼å…ˆåˆä½µåŒé¡é …å†è™•ç†æ­£è² è™Ÿã€‚</p>
      <div class="row" style="justify-content:flex-end;">
        <button id="closeHelp">é—œé–‰</button>
      </div>
    </div>
  </dialog>

  <script>
    // ===== å·¥å…·å‡½æ•¸ =====
    const rnd = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    // å°‡ ax+b æ­£è¦åŒ–ç‚º {a,b}ï¼Œæ¥å—è¼¸å…¥å¦‚: 3x+2, -x-5, +2x-3, 7, -4x
    function parseLinear(expr){
      const s = (expr||"").toString().replace(/\s+/g,"").toLowerCase();
      if(!s) return null;
      // å…è¨±åªæœ‰å¸¸æ•¸æˆ–åªæœ‰ x
      const re = /^([+-]?\d*)x(?:([+-]?\d+))?$|^([+-]?\d+)$/;
      const m = s.match(re);
      if(!m) return null;
      if(m[3] !== undefined){ // åªæœ‰å¸¸æ•¸
        return {a:0, b: Number(m[3])};
      }
      let a = m[1];
      if(a === '' || a === '+') a = 1; else if(a === '-') a = -1; else a = Number(a);
      const b = m[2] ? Number(m[2]) : 0;
      return {a,b};
    }

    function formatLinear({a,b}){
      const aStr = (a===1)?"x":(a===-1?"-x":(a===0?"":`${a}x`));
      const bStr = (b===0)?"":(b>0?(a!==0?`+${b}`:`${b}`):`${b}`);
      return (aStr||bStr)||"0";
    }

    function linearAddSub(e1, e2, op){
      const p1 = parseLinear(e1), p2 = parseLinear(e2);
      if(!p1 || !p2) return null;
      const sign = (op==='+')?1:-1;
      const res = { a: p1.a + sign*p2.a, b: p1.b + sign*p2.b };
      return formatLinear(res);
    }

    function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a; }

    // ===== é¡Œç›®ç”Ÿæˆå™¨ =====
    function getRanges(diff){
      if(diff==='easy') return { n1:[0,20], n2:[0,20], mul1:[2,9], mul2:[2,9], divQ:[2,9], powB:[2,5], powE:[2,3], c:[-9,9] };
      if(diff==='hard') return { n1:[-200,200], n2:[-200,200], mul1:[6,19], mul2:[6,19], divQ:[3,19], powB:[2,9], powE:[2,4], c:[-20,20] };
      return { n1:[-50,50], n2:[-50,50], mul1:[4,12], mul2:[2,12], divQ:[2,12], powB:[2,7], powE:[2,3], c:[-12,12] };
    }

    function genAddSub(r){
      let a=rnd(r.n1[0], r.n1[1]);
      let b=rnd(r.n2[0], r.n2[1]);
      // é¿å…å¤ª trivial
      if(Math.abs(b) < 2) b += (b>=0?2:-2);
      const op = choice(['+','-']);
      const text = `${a} ${op} ${b}`;
      const ans = (op==='+')? (a+b) : (a-b);
      return {text, ans: ans.toString(), hint:`å…ˆç®—æ­£è² è™Ÿï¼Œå†å¾å¤§çš„çµ•å°å€¼æ¸›å°çš„çµ•å°å€¼ã€‚`};
    }

    function genMul(r){
      const a=rnd(r.mul1[0], r.mul1[1]);
      const b=rnd(r.mul2[0], r.mul2[1]);
      return {text:`${a} Ã— ${b}`, ans:(a*b).toString(), hint:`å¯ç”¨åˆ†è§£ï¼š${a}Ã—${b} = ${a}Ã—(${Math.floor(b/2)}+${Math.ceil(b/2)})ã€‚`};
    }

    function genDiv(r){
      // å…ˆæ±ºå®šå•†èˆ‡é™¤æ•¸ï¼Œä¿è­‰æ•´é™¤
      const q=rnd(r.divQ[0], r.divQ[1]);
      const d=rnd(2, r.divQ[1]);
      const a=q*d;
      return {text:`${a} Ã· ${d}`, ans:q.toString(), hint:`å› æ•¸åˆ†è§£ï¼š${a} = ${q}Ã—${d}ã€‚`};
    }

    function genPow(r){
      const b=rnd(r.powB[0], r.powB[1]);
      const e=rnd(r.powE[0], r.powE[1]);
      const val = Math.pow(b,e);
      return {text:`${b}^${e}`, ans: val.toString(), hint:`ä¹˜æ–¹ï¼é‡è¤‡ä¹˜æ³•ï¼š${b}^${e} = ${Array(e).fill(b).join('Ã—')}ã€‚`};
    }

    function genPoly(r){
      // (a1 x + b1) (+|-) (a2 x + b2)
      const a1 = rnd(-9,9); const b1 = rnd(r.c[0], r.c[1]);
      let a2 = rnd(-9,9); let b2 = rnd(r.c[0], r.c[1]);
      if(a1===0 && a2===0) a2 = choice([-1,1,2]);
      const op = choice(['+','-']);
      const left = `${a1===0?"":(a1===1?"x":(a1===-1?"-x":`${a1}x`))}${b1===0?"":(b1>0?`+${b1}`:`${b1}`)}` || '0';
      const right = `${a2===0?"":(a2===1?"x":(a2===-1?"-x":`${a2}x`))}${b2===0?"":(b2>0?`+${b2}`:`${b2}`)}` || '0';
      const text = `(${left}) ${op} (${right})`;
      const ans = linearAddSub(left, right, op);
      const hint = `åŒé¡é …åˆä½µï¼šx é …ç›¸åŠ æ¸›ã€å¸¸æ•¸é …ç›¸åŠ æ¸›ã€‚`;
      return {text, ans, hint};
    }

    function genProblem(mode, diff){
      const r = getRanges(diff);
      switch(mode){
        case 'addsub': return genAddSub(r);
        case 'mul': return genMul(r);
        case 'div': return genDiv(r);
        case 'pow': return genPow(r);
        case 'poly': return genPoly(r);
      }
    }

    // ===== ç‹€æ…‹ç®¡ç† =====
    const ui = {
      mode: document.getElementById('mode'),
      diff: document.getElementById('difficulty'),
      count: document.getElementById('count'),
      perSec: document.getElementById('perSec'),
      start: document.getElementById('startBtn'),
      endless: document.getElementById('endlessBtn'),
      daily: document.getElementById('dailyBtn'),
      status: document.getElementById('status'),
      problem: document.getElementById('problem'),
      answer: document.getElementById('answer'),
      submit: document.getElementById('submitBtn'),
      skip: document.getElementById('skipBtn'),
      feedback: document.getElementById('feedback'),
      hint: document.getElementById('hint'),
      footer: document.getElementById('footer'),
      qStat: document.getElementById('qStat'),
      acc: document.getElementById('acc'),
      timer: document.getElementById('timer'),
      streak: document.getElementById('streak'),
      hall: document.getElementById('hall'),
      resultCard: document.getElementById('resultCard'),
      report: document.getElementById('report'),
      copyBtn: document.getElementById('copyBtn'),
      helpBtn: document.getElementById('helpBtn'),
      helpDialog: document.getElementById('helpDialog'),
      closeHelp: document.getElementById('closeHelp'),
      dailyTag: document.getElementById('dailyTag'),
    };

    let state = {
      mode: 'addsub', diff: 'mid', limit: 20, perSec: 0,
      endless: false, running: false, total: 0, correct: 0, streak: 0,
      remain: 0, current: null, timerId: null, tLeft: 0, startAt: 0, answered: 0
    };

    function resetStats(){ state.total=0; state.correct=0; state.streak=0; state.answered=0; updateStats(); }
    function updateStats(){
      ui.qStat.textContent = `${state.answered}/${state.total}`;
      const acc = state.answered? Math.round(100*state.correct/state.answered):0;
      ui.acc.textContent = `${acc}%`;
      ui.streak.textContent = `${state.streak} ğŸ”¥`;
    }

    function setStatus(msg){ ui.status.textContent = msg; }
    function setFooter(){
      const modeMap = { addsub:'åŠ æ¸›', mul:'ä¹˜æ³•', div:'é™¤æ³•', pow:'ä¹˜æ–¹', poly:'æ•´å¼åŠ æ¸›' };
      ui.footer.textContent = `æ¨¡å¼ï¼š${modeMap[state.mode]}ï½œé›£åº¦ï¼š${{easy:'å…¥é–€',mid:'ä¸€èˆ¬',hard:'æŒ‘æˆ°'}[state.diff]}${state.endless? 'ï½œç„¡é™ç·´ç¿’': 'ï½œä½œæ¥­æ¨¡å¼'}${state.perSec? `ï½œæ¯é¡Œé™æ™‚ ${state.perSec}s`: ''}`;
    }

    function nextProblem(){
      state.current = genProblem(state.mode, state.diff);
      ui.problem.textContent = state.current.text;
      ui.hint.textContent = '';
      ui.feedback.textContent = '';
      ui.answer.value = '';
      ui.answer.focus();
      if(state.perSec>0){ startCountdown(state.perSec); } else { ui.timer.textContent = 'â€”'; }
    }

    function startCountdown(sec){
      clearInterval(state.timerId);
      state.tLeft = sec;
      ui.timer.textContent = state.tLeft + 's';
      state.timerId = setInterval(()=>{
        state.tLeft--; ui.timer.textContent = state.tLeft + 's';
        if(state.tLeft<=0){ clearInterval(state.timerId); timesUp(); }
      }, 1000);
    }

    function timesUp(){
      ui.feedback.innerHTML = `<span class="bad">é€¾æ™‚ï¼</span> æ­£ç¢ºç­”æ¡ˆï¼š<span class="good">${state.current.ans}</span>`;
      ui.hint.textContent = state.current.hint || '';
      state.answered++; state.streak = 0; updateStats();
      proceedAfterAnswer(false);
    }

    function checkAnswer(){
      if(!state.running) return;
      const user = ui.answer.value.trim();
      if(!user) return;
      let ok=false;
      if(state.mode==='poly'){
        const got = parseLinear(user);
        const key = parseLinear(state.current.ans);
        if(got && key && got.a===key.a && got.b===key.b) ok=true;
      } else {
        // æ•¸å€¼æ¯”å°ï¼Œå…è¨±å‰å°é›¶èˆ‡ç©ºç™½
        ok = (user.replace(/\s+/g,'') === state.current.ans.toString());
      }
      clearInterval(state.timerId);
      state.answered++;
      if(ok){
        state.correct++; state.streak++;
        ui.feedback.innerHTML = `<span class="good">âœ” æ­£ç¢ºï¼</span>`;
      }else{
        state.streak = 0;
        ui.feedback.innerHTML = `<span class="bad">âœ˜ éŒ¯èª¤</span> æ­£ç¢ºç­”æ¡ˆï¼š<span class="good">${state.current.ans}</span>`;
        ui.hint.textContent = state.current.hint || '';
      }
      updateStats();
      proceedAfterAnswer(ok);
    }

    function proceedAfterAnswer(ok){
      // ç„¡é™æ¨¡å¼ï¼šçŸ­æš«åœé “å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ
      if(state.endless){
        setTimeout(nextProblem, 500);
        return;
      }
      // ä½œæ¥­æ¨¡å¼ï¼šè¨ˆæ•¸
      if(state.remain>1){
        state.remain--; ui.qStat.textContent = `${state.answered}/${state.total}`;
        setTimeout(nextProblem, 400);
      } else {
        finishSet();
      }
    }

    function finishSet(){
      state.running = false; clearInterval(state.timerId);
      const acc = state.answered? Math.round(100*state.correct/state.answered):0;
      setStatus('å·²å®Œæˆ âœ…');
      const spend = Math.round((Date.now()-state.startAt)/1000);
      saveBest(acc);
      const stamp = new Date().toLocaleString();
      const report = [
        `å®Œæˆæ™‚é–“ï¼š${stamp}`,
        `æ¨¡å¼ï¼š${{addsub:'åŠ æ¸›',mul:'ä¹˜æ³•',div:'é™¤æ³•',pow:'ä¹˜æ–¹',poly:'æ•´å¼åŠ æ¸›'}[state.mode]}`,
        `é›£åº¦ï¼š${{easy:'å…¥é–€',mid:'ä¸€èˆ¬',hard:'æŒ‘æˆ°'}[state.diff]}`,
        `é¡Œç›®æ•¸ï¼š${state.total}`,
        `æ¯é¡Œé™æ™‚ï¼š${state.perSec||'ä¸é™'}`,
        `æ­£ç¢ºï¼š${state.correct}ï¼${state.answered}ï¼ˆ${acc}%ï¼‰`,
        `è€—æ™‚ï¼š${spend} ç§’`,
      ].join('\n');
      ui.report.textContent = report + '\n\nâ€”â€” å°‡ä»¥ä¸Šæˆç¸¾è²¼åˆ°å­¸ç¿’å¹³å° â€”â€”';
      ui.resultCard.style.display = 'block';
    }

    function startSet(endless=false, dailySeed=null){
      state.mode = ui.mode.value; state.diff = ui.difficulty.value;
      state.limit = Math.max(5, Math.min(100, Number(ui.count.value)||20));
      state.perSec = Math.max(0, Math.min(120, Number(ui.perSec.value)||0));
      state.endless = endless; state.running = true; ui.resultCard.style.display='none';
      resetStats();
      if(endless){
        state.total = 0; state.remain = Infinity; setStatus('ç„¡é™ç·´ç¿’ä¸­');
      } else {
        state.total = state.limit; state.remain = state.limit; setStatus('ä½œæ¥­é€²è¡Œä¸­â€¦');
      }
      setFooter();
      state.startAt = Date.now();
      if(dailySeed!==null){
        // ä½¿ç”¨å›ºå®šäº‚æ•¸ç¨®å­ä»¥ä¿è­‰åŒä¸€å¤©é¡Œç›®ä¸€è‡´
        seededRandom.seed = dailySeed;
        Math.random = seededRandom; // è¦†è“‹æ–¼æœ¬å›åˆç”Ÿæ•ˆ
      }
      nextProblem();
    }

    // å…·æœ‰ç¨®å­çš„äº‚æ•¸ï¼ˆç·šæ€§åŒé¤˜ç”¢ç”Ÿå™¨ï¼‰
    function seededRandom(){
      const m=2**31-1; const a=48271; seededRandom.seed = (seededRandom.seed||123456789) % m;
      seededRandom.seed = (a * seededRandom.seed) % m;
      return (seededRandom.seed) / m;
    }

    // ===== æ’è¡Œï¼æ­·å²æœ€ä½³ =====
    function saveBest(acc){
      const key = `best-${state.mode}-${state.diff}`;
      const prev = Number(localStorage.getItem(key)||0);
      if(acc>prev){ localStorage.setItem(key, acc); }
      renderHall();
    }

    function renderHall(){
      const modes=['addsub','mul','div','pow','poly'];
      const names={addsub:'åŠ æ¸›',mul:'ä¹˜æ³•',div:'é™¤æ³•',pow:'ä¹˜æ–¹',poly:'æ•´å¼åŠ æ¸›'};
      const diffs=['easy','mid','hard']; const dnames={easy:'å…¥é–€',mid:'ä¸€èˆ¬',hard:'æŒ‘æˆ°'};
      ui.hall.innerHTML = modes.map(m=>{
        return `<div style="margin:6px 0 10px;">`+
               `<div class="small" style="margin-bottom:4px; color:#cbd5e1;">${names[m]}</div>`+
               diffs.map(d=>{
                 const v = localStorage.getItem(`best-${m}-${d}`) || 'â€”';
                 return `<div class="row" style="justify-content:space-between; margin:2px 0;">
                          <span class="pill">${dnames[d]}</span>
                          <span class="stat">${v}%</span>
                        </div>`;
               }).join('')+
               `</div>`;
      }).join('');
    }

    function setDailyTag(){
      const today = new Date();
      const y = today.getFullYear(); const m = (today.getMonth()+1).toString().padStart(2,'0'); const d = today.getDate().toString().padStart(2,'0');
      ui.dailyTag.textContent = `æ¯æ—¥æŒ‘æˆ° ${y}-${m}-${d}`;
    }

    // ===== äº‹ä»¶ =====
    ui.start.addEventListener('click', ()=> startSet(false));
    ui.endless.addEventListener('click', ()=> startSet(true));
    ui.daily.addEventListener('click', ()=>{
      const today = new Date();
      const seed = Number(`${today.getFullYear()}${today.getMonth()+1}${today.getDate()}`);
      startSet(false, seed); // ä»ç‚ºä½œæ¥­æ¨¡å¼ï¼Œé¡Œç›®å›ºå®š
    });
    ui.submit.addEventListener('click', checkAnswer);
    ui.skip.addEventListener('click', ()=>{ clearInterval(state.timerId); ui.feedback.textContent=''; ui.hint.textContent=''; nextProblem(); });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); }
      if(e.code==='Space'){ e.preventDefault(); clearInterval(state.timerId); nextProblem(); }
    });

    ui.helpBtn.addEventListener('click', ()=> ui.helpDialog.showModal());
    ui.closeHelp.addEventListener('click', ()=> ui.helpDialog.close());

    ui.copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(ui.report.textContent); ui.copyBtn.textContent='å·²è¤‡è£½'; setTimeout(()=>ui.copyBtn.textContent='è¤‡è£½æˆç¸¾æ–‡å­—', 1200); }catch(err){ alert('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚'); }
    });

    // åˆå§‹åŒ–
    renderHall(); setDailyTag(); setFooter();
  </script>
</body>
</html>
